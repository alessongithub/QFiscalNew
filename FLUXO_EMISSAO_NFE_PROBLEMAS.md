# Fluxo de EmissÃ£o NFe - Mapeamento Visual de Problemas

## ğŸ¯ VisÃ£o Geral

Este documento complementa `ANALISE_UN_PRINCIPAL.md` com diagramas visuais dos fluxos problemÃ¡ticos.

---

## ğŸ“Š FLUXO ATUAL (PROBLEMÃTICO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INÃCIO: EmitirNFeJSON                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 1: ConstruÃ§Ã£o Objeto ACBr (linhas 903-1267)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ LÃª JSON                                                â”‚   â”‚
â”‚  â”‚ â€¢ Configura certificado                                  â”‚   â”‚
â”‚  â”‚ â€¢ Monta IDE, Emitente, DestinatÃ¡rio                     â”‚   â”‚
â”‚  â”‚ â€¢ Loop: Para cada produto:                              â”‚   â”‚
â”‚  â”‚     â””â”€> Det.New                                         â”‚   â”‚
â”‚  â”‚         â””â”€> Prod.vProd, Prod.vDesc                      â”‚   â”‚
â”‚  â”‚         â””â”€> Imposto.ICMS (do JSON)                      â”‚   â”‚
â”‚  â”‚ â€¢ Loop: Para cada pagamento:                            â”‚   â”‚
â”‚  â”‚     â””â”€> pag.New                                         â”‚   â”‚
â”‚  â”‚         â””â”€> vPag (sem tPag!)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  Resultado: Objeto ACBr parcialmente preenchido                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 2: Ajuste Totais (linhas 1270-1336)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Total.ICMSTot.vProd = JSON.totais.vProd                 â”‚   â”‚
â”‚  â”‚ Total.ICMSTot.vDesc = JSON.totais.vDesc                 â”‚   â”‚
â”‚  â”‚ Total.ICMSTot.vNF = JSON.totais.vNF                     â”‚   â”‚
â”‚  â”‚ Total.ICMSTot.vBC = somatÃ³rio ICMS dos itens            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Sobrescreve valores calculados na Fase 1         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 3: Primeiro XML (linhas 1339-1365)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ACBr.NotasFiscais[0].GravarXML(pre_envio_*.xml)         â”‚   â”‚
â”‚  â”‚ Anexa base64 na resposta                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  XML Gerado: âœ… VÃ¡lido, mas com valores potencialmente errados  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 4: Ajustes NFC-e via String (linhas 1368-1415)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ XML_string = ReadFile(pre_envio_*.xml)                  â”‚   â”‚
â”‚  â”‚ XML_string = StringReplace(dhEmi)                       â”‚   â”‚
â”‚  â”‚ XML_string = StringReplace(indPres, tpImp, indFinal)    â”‚   â”‚
â”‚  â”‚ WriteFile(pre_envio_*.xml, XML_string)                  â”‚   â”‚
â”‚  â”‚ ACBr.LoadFromFile(pre_envio_*.xml) â† RECARREGA!         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: LoadFromFile faz parse e REGENERA XML interno    â”‚
â”‚  ğŸ”´ Ajustes string podem ser normalizados/perdidos pelo ACBr    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 5: InjeÃ§Ã£o <detPag> via String (linhas 1417-1485)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ XML_string = ReadFile(pre_envio_*.xml)                  â”‚   â”‚
â”‚  â”‚ if NOT Pos('<detPag>', XML_string) then                 â”‚   â”‚
â”‚  â”‚   Injeta: <pag><detPag><tPag>01</tPag><vPag>...         â”‚   â”‚
â”‚  â”‚ WriteFile(pre_envio_*.xml, XML_string)                  â”‚   â”‚
â”‚  â”‚ ACBr.LoadFromFile(pre_envio_*.xml) â† RECARREGA!         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Segunda manipulaÃ§Ã£o string sobre XML jÃ¡ alterado â”‚
â”‚  ğŸ”´ Offset de busca pode estar errado devido a mudanÃ§as Fase 4  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 6: Ajuste indFinal (linhas 1488-1552)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if IsConsumidorFinal then                               â”‚   â”‚
â”‚  â”‚   XML_string = ReadFile(pre_envio_*.xml)               â”‚   â”‚
â”‚  â”‚   ForÃ§a indFinal=1                                      â”‚   â”‚
â”‚  â”‚   Calcula: deltaVDesc = vNF - vPag                      â”‚   â”‚
â”‚  â”‚   Injeta/atualiza vDesc no <ICMSTot> e no item         â”‚   â”‚
â”‚  â”‚   Atualiza vNF = vPag                                   â”‚   â”‚
â”‚  â”‚   WriteFile(pre_envio_*.xml, XML_string)               â”‚   â”‚
â”‚  â”‚   ACBr.LoadFromFile(pre_envio_*.xml) â† RECARREGA!       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Terceira manipulaÃ§Ã£o string                      â”‚
â”‚  ğŸ”´ CÃ¡lculo de delta pode usar vNF errado (da Fase 2)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 7: ReconciliaÃ§Ã£o vNF/vPag (linhas 1554-1642)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ XML_string = ReadFile(pre_envio_*.xml)                  â”‚   â”‚
â”‚  â”‚ Extrai vNF e soma todos <vPag>                          â”‚   â”‚
â”‚  â”‚ if Abs(vNF - vPagTotal) > 0.001 then                    â”‚   â”‚
â”‚  â”‚   vDescNeeded = vNF - vPagTotal                         â”‚   â”‚
â”‚  â”‚   Atualiza <vDesc> em <ICMSTot>                         â”‚   â”‚
â”‚  â”‚   Atualiza <vNF> = vPagTotal                            â”‚   â”‚
â”‚  â”‚   WriteFile(pre_envio_*.xml, XML_string)               â”‚   â”‚
â”‚  â”‚   ACBr.LoadFromFile(pre_envio_*.xml) â† RECARREGA!       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Quarta manipulaÃ§Ã£o string                        â”‚
â”‚  ğŸ”´ DUPLICA lÃ³gica da Fase 6                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 8: Ajuste via Objeto (linhas 1652-1678)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Soma pag[i].vPag                                        â”‚   â”‚
â”‚  â”‚ if Abs(vNF - paySum) > 0.001 then                       â”‚   â”‚
â”‚  â”‚   Total.ICMSTot.vDesc += (vNF - paySum)                â”‚   â”‚
â”‚  â”‚   Total.ICMSTot.vNF = paySum                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Manipula OBJETO, mas XML em arquivo diverge      â”‚
â”‚  ğŸ”´ ACBr regenera XML internamente, descartando ajustes string  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”¥ FASE 9: PASSAGEM CRÃTICA - XmlMem (linhas 1679-2168) ğŸ”¥    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ XmlMem = ACBr.NotasFiscais[0].XML â† Pega XML do objeto  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.1: Injeta <detPag> se ausente              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   if NOT Pos('<detPag>', XmlMem) then              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Injeta <detPag><tPag>01</tPag><vPag>...        â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.2: Higieniza campos                        â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   XmlMem = StringReplace(xCpl nullâ†’vazio)          â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   XmlMem = StringReplace(indPres 0â†’1)              â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.3: Atualiza dhEmi                          â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Busca <dhEmi>                                     â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Substitui por Now()                               â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.4: Empurra delta para primeiro item        â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   deltaDesc = vNF - vPagTotal                       â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Busca primeiro <det>                              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Atualiza/injeta <vDesc> no item                   â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.5: Recalcula vDesc total                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   sumDesc = 0                                       â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Loop: para cada <det>                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     sumDesc += <vDesc> do item                      â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Atualiza <vDesc> em <ICMSTot>                     â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.6: Atualiza vNF em ICMSTot                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   vNFStrNew = FormatFloat(vPagTotal)                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Substitui <vNF> em <ICMSTot>                      â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.7: Sincroniza ICMS primeiro item â† TOTAL   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   totBCStr = <vBC> de <ICMSTot>                     â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   totICMSStr = <vICMS> de <ICMSTot>                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Copia para <ICMS00> do PRIMEIRO item              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   âš ï¸  INVERTIDO: deveria ser itemâ†’total!            â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.8: Atualiza tributos de TODOS os itens     â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Loop: para cada <det>                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     baseNet = vProd - vDesc                         â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza ICMS00:                                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vBC = baseNet                                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       pICMS = 18.00                                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vICMS = baseNet * 0.18                        â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza PIS:                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vBC = baseNet                                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       pPIS = 1.65                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vPIS = baseNet * 0.0165                       â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza COFINS:                                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vBC = baseNet                                 â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       pCOFINS = 7.60                                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚       vCOFINS = baseNet * 0.076                     â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.9: Remove IBSCBS                            â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   While Pos('<IBSCBS', XmlMem) > 0 do              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Remove bloco completo                           â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.10: ğŸ”´ RECALCULA tributos NOVAMENTE         â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   sumDescIt = 0                                     â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Loop: para cada <det>                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     baseNet = vProd - vDesc                         â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza ICMS00 (MESMA LÃ“GICA 9.8!)             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza PIS (MESMA LÃ“GICA 9.8!)                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     Atualiza COFINS (MESMA LÃ“GICA 9.8!)             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     sumDescIt += vDesc do item                      â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   âš ï¸  PROBLEMA: DUPLICAÃ‡ÃƒO COMPLETA DA ETAPA 9.8!   â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ ETAPA 9.11: Ajusta ICMSTot NOVAMENTE               â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Atualiza <vDesc> = sumDescIt                      â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Recalcula vNF = soma de vPag                      â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Atualiza <vNF>                                    â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   âš ï¸  PROBLEMA: DUPLICA lÃ³gica 9.5 e 9.6!           â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  ğŸ”´ RESULTADO: XmlMem contÃ©m XML MASSIVAMENTE manipulado       â”‚
â”‚  ğŸ”´ RISCO ALTO: Pos/Copy podem ter usado offsets errados       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 10: PersistÃªncia Final (linhas 2170-2181)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WriteFile(pre_envio_final_*.xml, XmlMem)               â”‚   â”‚
â”‚  â”‚ ACBr.LoadFromFile(pre_envio_final_*.xml) â† RECARREGA!   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: Se XmlMem estiver corrompido, parse falha       â”‚
â”‚  ğŸ”´ ACBr pode normalizar e descartar ajustes                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â›” FASE 11: ETAPA DERRADEIRA - DESATIVADA (linhas 2184-2315) â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if False then try                                       â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ XmlFinal = ACBr.XML                              â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ Remove IBSCBS                                    â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ Recalcula tributos (TERCEIRA VEZ!)               â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ Ajusta ICMSTot (TERCEIRA VEZ!)                   â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ WriteFile(pre_envio_final, XmlFinal)            â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ ACBr.LoadFromFile(pre_envio_final)              â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚ except end;                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  ğŸ”´ DESATIVADA porque estava corrompendo o XML                  â”‚
â”‚  âš ï¸  HistÃ³rico: "StartTag: invalid element name"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 12: Envio SEFAZ (linha 2322)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ACBrNFe1.Enviar(1, False, True)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  âš ï¸  PROBLEMA: XML enviado pode nÃ£o conter todos os ajustes     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIM: Retorna JSON com resultado              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ZOOM: Problema da SincronizaÃ§Ã£o Invertida (FASE 9.7)

### Fluxo ATUAL (ERRADO):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   <ICMSTot>      â”‚
â”‚   vBC = 142.00   â”‚â”€â”€â”€â”
â”‚   vICMS = 25.56  â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                       â”‚ Copia valores
                       â”‚ do TOTAL para
                       â”‚ o ITEM
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <det nItem="1">                     â”‚
â”‚    <ICMS00>                          â”‚
â”‚      vBC = 142.00    â† Copiado       â”‚
â”‚      pICMS = 18.00                   â”‚
â”‚      vICMS = 25.56   â† Copiado       â”‚
â”‚    </ICMS00>                         â”‚
â”‚  </det>                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <det nItem="2">                     â”‚
â”‚    <ICMS00>                          â”‚
â”‚      vBC = 0.00      â† NUNCA AJUSTADOâ”‚
â”‚      pICMS = 18.00                   â”‚
â”‚      vICMS = 0.00    â† NUNCA AJUSTADOâ”‚
â”‚    </ICMS00>                         â”‚
â”‚  </det>                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo CORRETO (Esperado pela SEFAZ):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <det nItem="1">                     â”‚
â”‚    <prod>                            â”‚
â”‚      vProd = 100.00                  â”‚
â”‚      vDesc = 5.00                    â”‚
â”‚    </prod>                           â”‚
â”‚    <ICMS00>                          â”‚
â”‚      vBC = 95.00    â† vProd-vDesc    â”‚
â”‚      pICMS = 18.00                   â”‚
â”‚      vICMS = 17.10  â† vBC * 0.18     â”‚
â”‚    </ICMS00>                         â”‚
â”‚  </det>                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Soma todos
              â”‚ os itens
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <det nItem="2">                     â”‚
â”‚    <prod>                            â”‚
â”‚      vProd = 50.00                   â”‚
â”‚      vDesc = 3.00                    â”‚
â”‚    </prod>                           â”‚
â”‚    <ICMS00>                          â”‚
â”‚      vBC = 47.00    â† vProd-vDesc    â”‚
â”‚      pICMS = 18.00                   â”‚
â”‚      vICMS = 8.46   â† vBC * 0.18     â”‚
â”‚    </ICMS00>                         â”‚
â”‚  </det>                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   <ICMSTot>                          â”‚
â”‚   vBC = 142.00    â† Î£(itens.vBC)     â”‚
â”‚   vICMS = 25.56   â† Î£(itens.vICMS)   â”‚
â”‚   vProd = 150.00  â† Î£(itens.vProd)   â”‚
â”‚   vDesc = 8.00    â† Î£(itens.vDesc)   â”‚
â”‚   vNF = 142.00    â† vProd-vDesc      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ CICLO DE RECARREGAMENTOS (LoadFromFile)

```
InÃ­cio
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACBr objeto criado         â”‚
â”‚ Det[0].Prod.vProd = 150    â”‚
â”‚ Det[0].Prod.vDesc = 8      â”‚
â”‚ pag[0].vPag = 142          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GravarXML(pre_envio.xml)   â”‚â—„â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                        â”‚
            â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ Manipula string:           â”‚       â”‚
â”‚ - Ajusta dhEmi             â”‚       â”‚
â”‚ - Injeta detPag            â”‚       â”‚
â”‚ - Corrige indPres          â”‚       â”‚
â”‚ WriteFile(pre_envio.xml)   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                        â”‚
            â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ LoadFromFile â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â†“                        â”‚       â”‚ Repete
â”‚ ACBr faz PARSE             â”‚       â”‚ 6-8x
â”‚   â†“                        â”‚       â”‚
â”‚ REGENERA XML interno       â”‚       â”‚
â”‚   â†“                        â”‚       â”‚
â”‚ Pode descartar ajustes     â”œâ”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¥ EXPLOSÃƒO DE COMPLEXIDADE

### Contagem de OperaÃ§Ãµes por Item:

```
Para 1 NFe com 1 item:

MANIPULAÃ‡Ã•ES DO CAMPO vDesc:
1. Linha 1099: vDesc lido do JSON
2. Linha 1292: vDesc do JSON â†’ Total.ICMSTot
3. Linha 1525: Delta calculado â†’ injeta vDesc
4. Linha 1764: Delta recalculado â†’ injeta vDesc (segunda vez)
5. Linha 1798: Soma vDesc itens â†’ ICMSTot.vDesc
6. Linha 2060: vDesc lido novamente durante loop
7. Linha 2110: Soma vDesc itens â†’ ICMSTot.vDesc (segunda vez)

TOTAL: 7 manipulaÃ§Ãµes do vDesc para 1 item!

MANIPULAÃ‡Ã•ES DO CAMPO vBC/vICMS (ICMS):
1. Linha 1126-1167: vBC/vICMS lido do JSON â†’ objeto
2. Linha 1281: vBC do JSON â†’ Total.ICMSTot
3. Linha 1328: vBC recalculado (soma itens) â†’ Total.ICMSTot
4. Linha 1914-1919: vBC/vICMS copiado de Total â†’ Item 1
5. Linha 1956-1976: vBC/vICMS recalculado para todos â†’ string
6. Linha 2063-2075: vBC/vICMS recalculado NOVAMENTE â†’ string

TOTAL: 6 manipulaÃ§Ãµes do vBC/vICMS para 1 item!

OPERAÃ‡Ã•ES DE I/O (Arquivo):
- GravarXML: 1x (linha 1346)
- ReadFile: 6x (linhas 1371, 1430, 1491, 1558, 1683)
- WriteFile: 6x (linhas 1409, 1470, 1544, 1635, 2175)
- LoadFromFile: 6x (linhas 1412, 1481, 1497, 1546, 1637, 2178)

TOTAL: 19 operaÃ§Ãµes de I/O para 1 NFe!
```

### Se NFe tiver 10 itens:
```
- ManipulaÃ§Ãµes vDesc: 7 + (6 Ã— 10) = 67
- ManipulaÃ§Ãµes vBC/vICMS: 6 + (5 Ã— 10) = 56
- OperaÃ§Ãµes I/O: 19 (independe do nÃºmero de itens)

TOTAL: 142 operaÃ§Ãµes para 10 itens!
```

---

## ğŸ¯ COMPARAÃ‡ÃƒO: ATUAL vs. IDEAL

### FLUXO ATUAL (ProblemÃ¡tico):

```
JSON â†’ Objeto ACBr â†’ XML1 â†’ String â†’ XML2 â†’ LoadFromFile â†’
       XML3 â†’ String â†’ XML4 â†’ LoadFromFile â†’ XML5 â†’ String â†’
       XML6 â†’ LoadFromFile â†’ XmlMem â†’ String manipulations (30+) â†’
       XML_final â†’ LoadFromFile â†’ Envio SEFAZ
```

**NÃºmero de transformaÃ§Ãµes:** 15+  
**NÃºmero de LoadFromFile:** 6+  
**NÃºmero de manipulaÃ§Ãµes string:** 40+  
**Risco de corrupÃ§Ã£o:** ğŸ”´ ALTO

---

### FLUXO IDEAL (Recomendado):

```
JSON â†’ Objeto ACBr â†’ ValidaÃ§Ã£o â†’ Assinatura â†’ Envio SEFAZ
```

**NÃºmero de transformaÃ§Ãµes:** 1  
**NÃºmero de LoadFromFile:** 0  
**NÃºmero de manipulaÃ§Ãµes string:** 0  
**Risco de corrupÃ§Ã£o:** ğŸŸ¢ BAIXO

---

## ğŸ”§ EXEMPLO DE CORREÃ‡ÃƒO (Item + Total)

### CÃ³digo ATUAL (Problema):

```pascal
// Fase 9, linha 1894-1925
// âŒ ERRADO: Copia do total para o item
var totBCStr := Copy(totBlock, totBC1+4, totBC2 - (totBC1+4));
var totICMSStr := Copy(totBlock, totIC1+7, totIC2 - (totIC1+7));

// Busca primeiro item
var detTxt := Copy(XmlMem, detRel, detEnd - detRel);
var icBlk := Copy(detTxt, icS, icE - icS + Length('</ICMS00>'));

// COPIA valores do total para o item
icBlk := Copy(icBlk, 1, b1+4) + totBCStr + Copy(icBlk, b2, MaxInt);
icBlk := Copy(icBlk, 1, v1+6) + totICMSStr + Copy(icBlk, v2, MaxInt);
```

### CÃ³digo CORRETO (Recomendado):

```pascal
// âœ… CORRETO: Calcula cada item e depois soma
var totalBC := 0.0;
var totalICMS := 0.0;

// 1. Calcula tributos de cada item
with ACBrNFe1.NotasFiscais.Items[0].NFe do
begin
  for i := 0 to Det.Count - 1 do
  begin
    // Base = valor lÃ­quido do item
    var baseNet := Det[i].Prod.vProd - Det[i].Prod.vDesc;
    
    // Atualiza ICMS do item
    Det[i].Imposto.ICMS.vBC := baseNet;
    Det[i].Imposto.ICMS.pICMS := GetAliquotaICMS(Ide.cUF, Det[i].Prod.CFOP);
    Det[i].Imposto.ICMS.vICMS := baseNet * (Det[i].Imposto.ICMS.pICMS / 100);
    
    // Acumula para o total
    totalBC := totalBC + Det[i].Imposto.ICMS.vBC;
    totalICMS := totalICMS + Det[i].Imposto.ICMS.vICMS;
  end;
  
  // 2. Atualiza total com a soma
  Total.ICMSTot.vBC := totalBC;
  Total.ICMSTot.vICMS := totalICMS;
end;
```

---

## ğŸ“ MATRIZ DE DEPENDÃŠNCIAS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Campo     â”‚ Fase 1   â”‚ Fase 2   â”‚ Fase 9   â”‚ Depende  â”‚
â”‚             â”‚ (Objeto) â”‚ (Objeto) â”‚ (String) â”‚   de     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ vProd       â”‚    âœ…    â”‚    âœ…    â”‚    âœ…    â”‚  JSON    â”‚
â”‚ vDesc       â”‚    âœ…    â”‚    âœ…    â”‚ âœ…âœ…âœ…âœ…  â”‚  JSON    â”‚
â”‚ vBC         â”‚    âœ…    â”‚    âœ…    â”‚ âœ…âœ…âœ…   â”‚  vProd-  â”‚
â”‚ vICMS       â”‚    âœ…    â”‚    âœ…    â”‚ âœ…âœ…âœ…   â”‚  vDesc   â”‚
â”‚ vNF         â”‚    âŒ    â”‚    âœ…    â”‚ âœ…âœ…âœ…   â”‚  Î£(vPag) â”‚
â”‚ vPag        â”‚    âœ…    â”‚    âŒ    â”‚ âœ…âœ…     â”‚  JSON    â”‚
â”‚ tPag        â”‚    âŒ    â”‚    âŒ    â”‚    âœ…    â”‚  JSON    â”‚
â”‚ dhEmi       â”‚    âŒ    â”‚    âŒ    â”‚ âœ…âœ…     â”‚  Now()   â”‚
â”‚ indPres     â”‚    âŒ    â”‚    âŒ    â”‚    âœ…    â”‚  LÃ³gica  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legenda:
âœ…   = Atualizado uma vez
âœ…âœ…  = Atualizado duas vezes
âœ…âœ…âœ… = Atualizado 3+ vezes
âŒ   = NÃ£o atualizado
```

---

## ğŸš¨ PONTOS DE FALHA CRÃTICOS

### 1. Linha 1792 - Reescreve primeiro <det>
```pascal
XmlMem := Copy(XmlMem, 1, detFirstRel-1) + detFirst + Copy(XmlMem, detFirstEnd, MaxInt);
```
**Risco:** Se `detFirstEnd` estiver errado, todo o XML apÃ³s o primeiro item Ã© CORTADO.

---

### 2. Linha 1928 - Reaplica bloco ICMSTot
```pascal
XmlMem := Copy(XmlMem, 1, totStart-1) + totBlock + Copy(XmlMem, totEnd, MaxInt);
```
**Risco:** Se `totEnd` foi calculado com XML anterior, offset estÃ¡ DESATUALIZADO.

---

### 3. Linha 2024 - Reaplica detBlock no loop
```pascal
XmlMem := Copy(XmlMem, 1, detStart-1) + detBlock + Copy(XmlMem, detEnd, MaxInt);
itemSearch := detStart + Length(detBlock);
```
**Risco:** 
- `detEnd` foi calculado ANTES de modificar `detBlock`
- `Length(detBlock)` pode ser diferente do tamanho original
- `itemSearch` pode pular ou duplicar itens

---

### 4. Linha 2106 - Segundo loop (DUPLICAÃ‡ÃƒO)
```pascal
XmlMem := Copy(XmlMem, 1, dAbs-1) + dTxt + Copy(XmlMem, dAbsEnd, MaxInt);
scanI := dAbs + Length(dTxt) + 1;
```
**Risco:** 
- MESMA lÃ³gica da linha 2024
- Trabalha sobre XML JÃ MODIFICADO pelo primeiro loop
- Offsets podem estar completamente errados

---

## ğŸ¬ CONCLUSÃƒO VISUAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ESTADO ATUAL DO CÃ“DIGO                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚        ğŸ—ï¸  ConstruÃ­do em camadas                           â”‚
â”‚        ğŸ”§  Cada camada "conserta" a anterior               â”‚
â”‚        ğŸ”„  MÃºltiplos ciclos de correÃ§Ã£o                     â”‚
â”‚        ğŸ“  ManipulaÃ§Ã£o string extensiva                     â”‚
â”‚        ğŸ’¾  Excesso de I/O (19 operaÃ§Ãµes)                    â”‚
â”‚        âš ï¸  CÃ³digo morto (130 linhas)                        â”‚
â”‚        ğŸ›  Bugs latentes (sincronizaÃ§Ã£o invertida)          â”‚
â”‚                                                             â”‚
â”‚  Resultado: ğŸ”´ XML frequentemente corrompido                â”‚
â”‚             ğŸ”´ Valores inconsistentes                       â”‚
â”‚             ğŸ”´ RejeiÃ§Ã£o SEFAZ imprevisÃ­vel                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SOLUÃ‡ÃƒO RECOMENDADA (Ideal)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚        âœ…  Manipular APENAS objeto ACBr                     â”‚
â”‚        âœ…  Calcular tributos UMA vez (itemâ†’total)           â”‚
â”‚        âœ…  Validar objeto ANTES de gerar XML                â”‚
â”‚        âœ…  Eliminar LoadFromFile (exceto no final)          â”‚
â”‚        âœ…  Remover cÃ³digo morto                             â”‚
â”‚        âœ…  Simplificar fluxo (5 fases â†’ 3 fases)            â”‚
â”‚                                                             â”‚
â”‚  Resultado: ğŸŸ¢ XML sempre vÃ¡lido                            â”‚
â”‚             ğŸŸ¢ Valores consistentes                         â”‚
â”‚             ğŸŸ¢ AprovaÃ§Ã£o SEFAZ previsÃ­vel                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š REFERÃŠNCIAS

- **Arquivo de anÃ¡lise principal:** `ANALISE_UN_PRINCIPAL.md`
- **Schema NFe 4.00:** `DelphiEmissor/PL_010b_NT2025_002_v1.21/*.xsd`
- **Manual SEFAZ:** [Portal da NF-e](http://www.nfe.fazenda.gov.br/)

---

**Documento gerado em:** 07/10/2025  
**Complementa:** ANALISE_UN_PRINCIPAL.md

